;(()=>{"use strict";
if(window.HC_WIDGET_LOADED) return;
window.HC_WIDGET_LOADED = true;

const API="https://hansel-cottage.onrender.com";

function onReady(fn){
  if(document.readyState==="complete"||document.readyState==="interactive"){
    setTimeout(fn,0);
  } else {
    document.addEventListener("DOMContentLoaded",fn,{once:true});
  }
}

function injectStyles(){
  const s=document.createElement("style");
  s.textContent="#hc-b{position:fixed;bottom:20px;right:20px;background:#4a5568;color:#fff;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:2147483647}#hc-w{position:fixed;bottom:84px;right:20px;width:320px;max-height:420px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);display:none;flex-direction:column;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;z-index:2147483647}#hc-h{background:#4a5568;color:#fff;padding:10px;font-weight:700}#hc-m{flex:1;padding:10px;overflow-y:auto;font-size:14px}#hc-i{display:flex;border-top:1px solid #ddd}#hc-t{flex:1;border:0;padding:8px;font-size:14px;outline:0}#hc-s{background:#4a5568;color:#fff;border:0;padding:0 14px;cursor:pointer;font-size:14px}";
  document.head.appendChild(s);
}

async function callJSON(path,opts){
  const res=await fetch(API+path,opts);
  if(!res.ok) throw new Error(path+" "+res.status);
  return res.json();
}

function mount(){
  injectStyles();

  const bubble=document.createElement("div");
  bubble.id="hc-b";
  bubble.textContent="💬";
  document.body.appendChild(bubble);

  const win=document.createElement("div");
  win.id="hc-w";
  win.innerHTML='<div id="hc-h">Hansel Cottage</div><div id="hc-m"></div><div id="hc-i"><input id="hc-t" placeholder="Ask about availability..."><button id="hc-s">Send</button></div>';
  document.body.appendChild(win);

  const msgs=win.querySelector("#hc-m");
  const input=win.querySelector("#hc-t");
  const btn=win.querySelector("#hc-s");

  function addMsg(who,txt){
    const d=document.createElement("div");
    d.innerHTML="<strong>"+who+":</strong> "+txt;
    msgs.appendChild(d);
    msgs.scrollTop=msgs.scrollHeight;
  }

  async function handleSend(text){
    try{
      const r=await callJSON("/api/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:text})
      });
      addMsg("Bot", r.answer || "Sorry, I didn't understand.");
    }catch(e){
      addMsg("Bot","⚠️ Error contacting server.");
      console.error("[hc] widget error",e);
    }
  }

  bubble.onclick=()=>{
    win.style.display = win.style.display==="flex" ? "none" : "flex";
    if(win.style.display==="flex") input.focus();
  };

  btn.onclick=()=>{
    const text=input.value.trim();
    if(!text) return;
    addMsg("You",text);
    input.value="";
    handleSend(text);
  };

  input.addEventListener("keypress",e=>{
    if(e.key==="Enter") btn.click();
  });

  console.log("[hc] widget mounted");
}

onReady(mount);
})();
