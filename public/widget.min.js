(()=>{const API=(document.currentScript&&document.currentScript.dataset.api)||"https://hansel-cottage.onrender.com";function mount(){const s=document.createElement("style");s.textContent="#hc-b{position:fixed;bottom:20px;right:20px;background:#4a5568;color:#fff;border-radius:50%;width:56px;height:56px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;box-shadow:0 4px 8px rgba(0,0,0,.2);z-index:999999}#hc-w{position:fixed;bottom:84px;right:20px;width:320px;max-height:420px;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);display:none;flex-direction:column;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;z-index:999999}#hc-h{background:#4a5568;color:#fff;padding:10px;font-weight:700}#hc-m{flex:1;padding:10px;overflow-y:auto;font-size:14px}#hc-i{display:flex;border-top:1px solid #ddd}#hc-t{flex:1;border:0;padding:8px;font-size:14px;outline:0}#hc-s{background:#4a5568;color:#fff;border:0;padding:0 14px;cursor:pointer;font-size:14px}",document.head.appendChild(s);const b=document.createElement("div");b.id="hc-b",b.textContent="💬",document.body.appendChild(b);const w=document.createElement("div");w.id="hc-w",w.innerHTML='<div id="hc-h">Hansel Cottage</div><div id="hc-m"></div><div id="hc-i"><input id="hc-t" placeholder="Ask about availability..."><button id="hc-s">Send</button></div>',document.body.appendChild(w);const M=w.querySelector("#hc-m"),T=w.querySelector("#hc-t"),S=w.querySelector("#hc-s");function add(u,t){const d=document.createElement("div");d.innerHTML=`<strong>${u}:</strong> ${t}`,M.appendChild(d),M.scrollTop=M.scrollHeight}function pad(n){return n<10?"0"+n:""+n}function fmtISO(d){return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())}function nextDow(target,from){const cur=from.getDay();const diff=(target-cur+7)%7||7;const out=new Date(from);out.setDate(from.getDate()+diff);return out}function parseNatural(msg){msg=msg.toLowerCase();const iso=/(\d{4}-\d{2}-\d{2})/.exec(msg);const dogs=/\b(?:with|and)\s+(\d+)\s+dogs?\b/.exec(msg);const nights=/\b(?:for\s+)?(\d+)\s+nights?\b/.exec(msg);let from=null;let nightsVal=nights?parseInt(nights[1],10):null;const now=new Date();const wdMap={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6};const wd=/\b(next\s+)?(sunday|monday|tuesday|wednesday|thursday|friday|saturday)\b/.exec(msg);if(iso){from=iso[1]}else if(/\btomorrow\b/.test(msg)){const d=new Date(now);d.setDate(d.getDate()+1);from=fmtISO(d)}else if(/\btoday\b/.test(msg)){from=fmtISO(now)}else if(/\bthis\s+weekend\b/.test(msg)){const sat=nextDow(6,now);from=fmtISO(sat)}else if(wd){const tag=wd[2].slice(0,3);const want=wdMap[tag];const d=nextDow(want,now);if(!wd[1]&&d.getDay()===now.getDay()){d.setDate(d.getDate()+7)}from=fmtISO(d)}else{const m=/\b(\d{1,2})\s*(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)\b/.exec(msg);const map={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,sept:8,oct:9,nov:10,dec:11};if(m){const day=parseInt(m[1],10);const mon=map[m[2]];const d=new Date();d.setMonth(mon,day);from=fmtISO(d)}}const dogsVal=dogs?parseInt(dogs[1],10):0;return {from,nights:nightsVal,dogs:dogsVal}}async function doAvailability(from,nights){const r=API+"/api/availability?from="+encodeURIComponent(from)+"&nights="+encodeURIComponent(nights);const res=await fetch(r);if(!res.ok)throw new Error("availability");return res.json()}async function doQuote(from,nights,dogs){const res=await fetch(API+"/api/quote",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from,nights,dogs:dogs||0})});if(!res.ok)throw new Error("quote");return res.json()}async function send(){const text=T.value.trim();if(!text)return;add("You",text);T.value="";try{const {from,nights,dogs}=parseNatural(text);if(from){const nn=nights||7;const a=await doAvailability(from,nn);if(a&&typeof a.available==="boolean"){if(a.available){add("Bot",`✅ It looks available from ${from} for ${nn} night(s).${nights?"":" (assumed 7 nights)"}`);try{const q=await doQuote(from,nn,dogs||0);add("Bot",`💷 Estimated total${dogs?` with ${dogs} dog(s)`:''}: ${q.currency} ${q.total}`);}catch{} }else{const sug=(a.suggestions||[]).map(x=>x.from).slice(0,3).join(", ");add("Bot","❌ Those dates look unavailable."+ (sug?` Try: ${sug}`:""));}return}}const res=await fetch(API+"/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:text})});const data=await res.json();add("Bot",data.answer||"Sorry, I didn't understand.");}catch{add("Bot","⚠️ Error contacting server.")}}const b=document.getElementById("hc-b"),w=document.getElementById("hc-w"),M=w.querySelector("#hc-m"),T=w.querySelector("#hc-t"),S=w.querySelector("#hc-s");b.onclick=()=>{w.style.display=w.style.display==="flex"?"none":"flex",w.style.display==="flex"&&T.focus()},S.onclick=send,T.addEventListener("keypress",e=>{e.key==="Enter"&&send()})}if(!window._hcWidget){window._hcWidget=1;mount()}})();
